@model IEnumerable<Fap.Core.Infrastructure.Metadata.FapColumn>
@using Fap.Core.Infrastructure.Metadata
<div class="row">
    <div class="col-xs-12 col-sm-2">
        <div class="widget-box light-border" style="opacity: 1;">
            <div class="widget-header  widget-header-flat">
                <h5 class="widget-title smaller">待选项</h5>
            </div>

            <div class="widget-body">
                <div class="widget-main padding-6 scrollable" data-size="500">
                    <div class="dd" id="nestable">
                        <ol class="dd-list">
                            @foreach (var column in Model)
                            {
                                <li class="dd-item" data-id="@column.ColName" data-title="@column.ColComment">
                                    <div class="dd-handle">
                                        @column.ColComment
                                        <div class="pull-right dd-nodrag" style="margin-left:10px">
                                            <a href="#" data-action="settings" data-toggle="dropdown" title="自定义图表类型">
                                                <i class="icon-only ace-icon fa fa-area-chart"></i>
                                            </a>
                                            <ul class="dropdown-menu dropdown-menu-right dropdown-light-blue dropdown-caret dropdown-closer">
                                                <li>
                                                    <a data-toggle="chart" data-setting="bar" href="javascript:void(0)">
                                                        <i class="icon-only ace-icon fa fa-bar-chart"></i>
                                                    </a>
                                                </li>
                                                <li>
                                                    <a data-toggle="chart" data-setting="line" href="javascript:void(0)">
                                                        <i class="icon-only ace-icon fa fa-line-chart"></i>
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                        @if (column.CtrlType == FapColumn.COL_TYPE_DATETIME || column.CtrlType == FapColumn.CTRL_TYPE_DATE)
                                        {
                                            <div class="pull-right dd-nodrag">
                                                <a href="#" data-action="settings" data-toggle="dropdown" title="格式">
                                                    F
                                                </a>
                                                <ul class="dropdown-menu dropdown-menu-right dropdown-light-blue dropdown-caret dropdown-closer">
                                                    <li>
                                                        <a data-toggle="format" data-setting="yyyy" href="javascript:void(0)">年</a>
                                                    </li>
                                                    <li>
                                                        <a data-toggle="format" data-setting="yyyymm" href="javascript:void(0)">年月</a>
                                                    </li>
                                                    <li>
                                                        <a data-toggle="format" data-setting="yyyymmdd" href="javascript:void(0)">年月日</a>
                                                    </li>
                                                </ul>
                                            </div>
                                        }
                                        else if (column.ColType == FapColumn.COL_TYPE_INT || column.ColType == FapColumn.COL_TYPE_LONG
                                           || column.ColType == FapColumn.CTRL_TYPE_MONEY || column.ColType == FapColumn.COL_TYPE_DOUBLE)
                                        {
                                            <div class="pull-right dd-nodrag">
                                                <a href="#" data-action="settings" data-toggle="dropdown" title="统计类型">
                                                    ∑
                                                </a>

                                                <ul class="dropdown-menu dropdown-menu-right dropdown-light-blue dropdown-caret dropdown-closer">
                                                    <li>
                                                        <a data-toggle="aggregate" data-setting="count" href="javascript:void(0)">计数</a>
                                                    </li>

                                                    <li>
                                                        <a data-toggle="aggregate" data-setting="sum" href="javascript:void(0)">求和</a>
                                                    </li>
                                                    <li>
                                                        <a data-toggle="aggregate" data-setting="avg" href="javascript:void(0)">平均值</a>
                                                    </li>
                                                </ul>
                                            </div>
                                        }


                                    </div>
                                </li>
                            }
                        </ol>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xs-12 col-sm-2" style="min-height: 106px;">
        <div class="widget-box  light-border" style="opacity: 1;">
            <div class="widget-header  widget-header-flat">
                <h5 class="widget-title smaller">选择区</h5>
                <div class="widget-toolbar">
                    <a href="javascript:void(0)" id="btnPreView" title="预览">
                        <i class="ace-icon fa fa-eye"></i>
                    </a>

                    <a href="#" data-action="reload">
                        <i class="ace-icon fa fa-save"></i>
                    </a>
                </div>
            </div>

            <div class="widget-body">
                <div class="widget-main padding-6">
                    <div>
                        <span>类型: &nbsp;</span>

                        <div data-toggle="buttons" class="btn-group charttype">
                            <label class="btn btn-white btn-info active">
                                <input type="radio" value="bar" checked />
                                <i class="icon-only ace-icon fa fa-bar-chart"></i>
                            </label>

                            <label class="btn btn-white btn-info">
                                <input type="radio" value="pie" />
                                <i class="icon-only ace-icon fa fa-pie-chart"></i>
                            </label>

                            <label class="btn btn-white btn-info">
                                <input type="radio" value="line" />
                                <i class="icon-only ace-icon fa fa-line-chart"></i>
                            </label>
                        </div>
                    </div>
                    <div class="space-10"></div>


                    <h4 class="header">Y轴(统计项)</h4>

                    <div class="dd dd-draghandle item-aggregate">

                        <div class="dd-empty" data-title="拖拽至此"></div>

                    </div>
                    <h4 class="header">X轴(分组项)</h4>

                    <div class="dd dd-draghandle item-group">

                        <div class="dd-empty" data-title="拖拽至此"></div>

                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="col-xs-12 col-sm-8">
        <div class="widget-box">
            <div class="widget-header  widget-header-flat">
                <h6 class="widget-title smaller">图表</h6>
            </div>

            <div class="widget-body">
                <div class="widget-main">
                    <div id="fapChart" style="width:600px;height:500px"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    setTimeout(function () {
        $('.dd').nestable({ maxDepth: 1 });
        $('.scrollable').each(function () {
            var $this = $(this);
            $(this).ace_scroll({
                size: $this.attr('data-size') || 500,
                styleClass: 'scroll-left scroll-margin scroll-thin  no-track '
            });
        });
        $("a[data-toggle=format]").on(ace.click_event, function () {
            $(this).closest(".dd-nodrag").find("a[data-action=settings]").text("F(" + $(this).text() + ")");
            $(this).closest(".dd-item").data("setting", $(this).data("setting"));
        });
        $("a[data-toggle=aggregate]").on(ace.click_event, function () {
            $(this).closest(".dd-nodrag").find("a[data-action=settings]").text("∑(" + $(this).text() + ")");
            $(this).closest(".dd-item").data("setting", $(this).data("setting"));
        }); 
        $("a[data-toggle=chart]").on(ace.click_event, function () {
            let t = $(this).data("setting");
            if (t === "bar") {
                $(this).closest(".dd-nodrag").find("a[data-action=settings]").html(" <i class='icon-only ace-icon fa fa-bar-chart'></i>");
            } else {
                $(this).closest(".dd-nodrag").find("a[data-action=settings]").html(" <i class='icon-only ace-icon fa fa-line-chart'></i>");
            }
            $(this).closest(".dd-item").data("charttype",t);
        });
    }, 0);
    var fapChart = echarts.init(document.getElementById('fapChart'));
    function initChartModel() {
        var chartType = $(".charttype .active").find("input[type=radio]:checked").val();
        if (chartType === "") {
            chartType = "bar";
        }
        var chartModel = { Aggregates: [], Groups: [], chartType: chartType };
        //分组
        var grps = $(".item-group .dd-item");
        $.each(grps, function (i, d) {
            let field = $(d).data("id");
            let name = $(d).data("title");
            let fmt = $(d).data("setting");
            if (fmt === undefined) {
                fmt = "";
            }
            chartModel.Groups.push({ Field: field, Alias: name, Format: fmt });
        })
        //统计
        var aggregates = $(".item-aggregate .dd-item");
        $.each(aggregates, function (i, d) {
            let field = $(d).data("id");
            let name = $(d).data("title");
            let tp = $(d).data("setting");
            if (tp === undefined) {
                tp = "count";
            }
            let specifyType = $(d).data("charttype");
            if (specifyType === undefined) {
                specifyType = "default";
            }
            chartModel.Aggregates.push({ Field: field, Alias: name, AggType: tp, SpecifyType: specifyType });
        })
        if (chartModel.Aggregates.length == 0) {
            chartModel.Aggregates.push({ Field: "1", Alias: "计数", AggType: "count",SpecifyType:"default" })
        }
        return chartModel;

    }
    function initChartOption() {
        var option = {
            legend: {},
            toolbox: {
                feature: {
                    dataView: { show: true, readOnly: false },
                    saveAsImage: { show: true }
                }
            },
            xAxis: { type: 'category' },
            yAxis: {},
            tooltip: {}
        };
        var colTitle = $(".item-group li:first").data("title");
        option.title = {
            text: colTitle,
        };
        return option;
    }
    var gridId;
    function initGridId(grdid) {
        gridId = grdid;
    }
    $("#btnPreView").on(ace.click_event, function () {
        var chartModel = initChartModel();
        var jqPostData = $('#' + gridId).jqGrid("getGridParam", "postData");
        $.post(basePath + '/Api/Core/EChart', { chartViewModel: chartModel, jqGridPostData: jqPostData }, function (rv) {
            fapChart.clear();
            var option = initChartOption();
            option.dataset = {
                dimensions: Object.keys(rv.data[0]),
                source: rv.data
            };
            var series = [];
            $.each(chartModel.Aggregates, function (i, d) {
                if (chartModel.chartType === "pie") {
                    series.push({ type: chartModel.chartType, radius: '50%' });
                } else {
                    if (d.SpecifyType === "default") {
                        series.push({ type: chartModel.chartType });
                    } else {
                        series.push({ type: d.SpecifyType });
                    }
                }
            })
            option.series = series;

            fapChart.setOption(option);
        });


    })
</script>